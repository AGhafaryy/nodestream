# Building a Database Connector

## Introduction

This guide will walk you through the process of building a database connector to a Graph Database.

In essence, a database connector for nodestream provides the pluggable behavior for the following: 

* `QueryExecutor` - Upserting nodes and edges into the graph database (Used for pipelines in `nodestream run`)
* `TypeRetriever` - Retrieving instances of a given node or relationship type from the graph database (Used for `nodestream copy`).
* `Migrator` - Updates the database to reflect changes in the project schema (Used for `nodestream migrations run`).

These three components are accessed through a `DatabaseConnector` which is the entry point for the connector and essentially acts 
as a [factory](https://refactoring.guru/design-patterns/abstract-factory) for the three components above. 

## Getting Started

To get started, you'll need to create a new project and install the `nodestream` package:

```bash
poetry new nodestream-plugin-mydb
cd nodestream-plugin-mydb
poetry add nodestream
```

Next, you'll need to create a new python module by creating a new file called `connector.py`. This file will contain the
implementation of the `DatabaseConnector` class.  We can stub out the class by adding the following code:

```python
from nodestream.databases import TypeRetriever, DatabaseConnector
from nodestream.databases.query_executor import QueryExecutor
from nodestream.schema.migrations import Migrator


class MyDbConnector(DatabaseConnector, alias="my-db"):
    def make_migrator(self) -> Migrator:
        # TODO: Implement
        ...

    def make_query_executor(self) -> QueryExecutor:
        # TODO: Implement
        ...

    def make_type_retriever(self) -> TypeRetriever:
        # TODO: Implement
        ...
```

The `DatabaseConnector` class is referenced by `alias` parameter which is used to identify the connector in the `nodestream.yaml` file.

## Impementing the QueryExecutor 

The `QueryExecutor` is responsible for upserting nodes and edges into the graph database.  
The `QueryExecutor` is a subclass of `nodestream.databases.query_executor.QueryExecutor`. 
The `QueryExecutor` provides for the following apis:

- Upserting a batch of nodes (of the same type) into the graph database. 
- Upserting a batch of relationships (of the same type) into the graph database.
- Expiring nodes and relationships from the graph database.
- Running consumer provided hooks provided from the [Ingestion Hooks](./ingestion-hooks.md) System.

Which is stubbed as follows:

```python
from typing import Iterable

from nodestream.model import (
    IngestionHook,
    Node,
    RelationshipWithNodes,
    TimeToLiveConfiguration,
)
from nodestream.databases.query_executor import (
    OperationOnNodeIdentity,
    OperationOnRelationshipIdentity,
    QueryExecutor,
)

class MyDbQueryExecutor(QueryExecutor):
    async def upsert_nodes_in_bulk_with_same_operation(
        self, operation: OperationOnNodeIdentity, nodes: Iterable[Node]
    ):
        ...

    async def upsert_relationships_in_bulk_of_same_operation(
        self,
        shape: OperationOnRelationshipIdentity,
        relationships: Iterable[RelationshipWithNodes],
    ):
        ...

    async def perform_ttl_op(self, config: TimeToLiveConfiguration):
        ...

    async def execute_hook(self, hook: IngestionHook):
        ...
```

Internally, nodestream batches up changes to nodes and relationships and provides to the database connector consolidated batches 
of nodes and relationships to be upserted. 
The `QueryExecutor` is responsible for translating these batches into the appropriate queries to be executed against the graph database.

Read the documentation for the `OperationOnNodeIdentity` and `OperationOnRelationshipIdentity` classes for discussion on how to translate these operations into queries. 
However, the general idea is that a query can be generated by examining the `OperationOnNodeIdentity` and `OperationOnRelationshipIdentity` objects and generating the appropriate query. 
The `Node` and `RelationshipWithNodes` objects are provided to the `QueryExecutor` to provide the data to be upserted. 